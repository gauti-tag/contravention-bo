<%= render 'shared/page-infos', tag: 'Journalisation', sub_tag: 'Rapport de gains', title: 'Rapport de gains' %>
<div class="row mb-3">
  <div class="col-12 col-xl-6">
    <div class="card border-0 shadow">
      <div class="card-header border-border-bottom">
        <div class="d-block">
          <div class="h6 fw-normal text-gray mb-2">Montant des gains</div>
          <h2 class="h3 fw-extrabold" id="winnings-wrapper"></h2>
        </div>
      </div>
      <div class="card-body table-wrapper table-responsive p-2">
        <table class="table table-centered table-nowrap mb-0 rounded" id="reports-table">
          <thead class="thead-light">
            <tr>
              <th class="border-0 rounded-start">#</th>
              <th class="border-0">Nombre</th>
              <th class="border-0 rounded-end">Montant (XOF)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="fw-bold">Tickets</td>
              <td class="text-center fw-extrabold" id="bets-number"></td>
              <td class="text-center fw-extrabold" id="bets-amount"></td>
            </tr>
            <tr>
              <td class="fw-bold">Gagnants</td>
              <td class="text-center fw-extrabold" id="winnings-number"></td>
              <td class="text-center fw-extrabold" id="winnings-amount"></td>
            </tr>
            <tr>
              <td class="fw-bold">Perdants</td>
              <td class="text-center fw-extrabold" id="losings-number"></td>
              <td class="text-center fw-extrabold" id="losings-amount"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-12 col-xl-4">
    <div class="card border-0 card-body shadow p-1">
      <div class="d-flex align-items-center justify-content-start flex-column mb-0">
        <div class="form-group mb-2 w-85">
          <label for="draw-date" class="form-label">Date de tirage:</label>
          <div class="input-group">
            <span class="input-group-text">
                <svg class="icon icon-xs" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
            </span>
            <input class="form-control" id="draw-date" name="draw-date" max='<%= Date.today.to_s %>' type="date">
          </div>
        </div>
        <div class="form-group mb-2 w-85">
          <label for="draws-list" class="form-label">Tirage:</label>
          <select id="draws-list" name="draws-list" class="form-select mb-0">
            <option value="">Sélectionnez un tirage</option>
          </select>
        </div>
        <div class="form-group mb-3 w-85">
          <label for="draw-numbers" class="form-label">Résultat:</label>
          <div class="pt-1" id="draw-numbers">
            <!-- display draw numbers -->
          </div>
        </div>
        <div class="btn-toolbar mb-2">
          <div class="btn-group ms-1 ms-lg-2">
            <button id="report-btn" type="button" class="btn btn-sm btn-primary d-inline-flex align-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-xxs me-2" fill="currentColor" role="img" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24"><path d="M5 19h-4v-8h4v8zm6 0h-4v-18h4v18zm6 0h-4v-12h4v12zm6 0h-4v-4h4v4zm1 2h-24v2h24v-2z"/></svg>
              Générer le rapport
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-12 col-xl-12">
    <div class="card border-0 shadow">
      <div class="card-header">
        <h2 class="fs-5 fw-bold mb-0">Tickets gagnants</h2>
      </div>
    </div>
    <div class="card-body table-wrapper table-responsive">
      <table class="table table-centered table-nowrap mb-0 rounded" id="reports-datatable">
        <thead class="thead-light">
          <tr>
            <th class="border-0 rounded-start">#</th>
            <th class="border-0">Numéros</th>
            <th class="border-0">Date</th>
            <th class="border-0">Mise</th>
            <th class="border-0">Gain</th>
            <th class="border-0">Statut</th>
            <th class="border-0 rounded-end">Détails</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<% content_for :page_javascript do %>
    <script type="text/javascript">
      var drawDateInput = document.getElementById('draw-date');
      var drawsList = document.getElementById('draws-list');
      var drawNumbers = document.getElementById('draw-numbers');
      var reportsTable = document.getElementById('reports-table');

      drawDateInput.addEventListener('change', e => {
        const drawDate = e.target.value;
        if (drawDate !== "") {
          fetch(`/api/draws/?date=${drawDate}`)
          .then(response => response.json())
          .then(data => {
            drawsList.innerHTML = "";
            drawNumbers.innerHTML = "";
            let option = document.createElement("option");
            option.value = "";
            option.text = "Sélectionnez un tirage"
            drawsList.appendChild(option);
            for (const val of data)
            {
              option = document.createElement("option");
              option.value = val.identifier;
              option.text = val.title;
              option.dataset.id = val.id;
              option.dataset.numbers = val.draw_numbers;
              drawsList.appendChild(option);
            }
          });
        }
      });

      drawsList.addEventListener('change', e => {
        if (e.target.value !== "") {
          drawNumbers.innerHTML = "";
          const option = e.target.options[e.target.selectedIndex];
          const numbers = option.dataset.numbers.split(',');
          if (numbers.length > 1) {
            numbers.forEach(num => {
              drawNumbers.insertAdjacentHTML('beforeend', `<span class="badge bg-primary"> ${num} </span>&nbsp;`);
            });
          }
        } 
      });

      $('#report-btn').click(function() {
        const drawId = drawsList.value;
        if (drawId !== "") {
          $.blockUI({message: 'Traitement en cours...'});
          const headers = new Headers();
          headers.append('Content-Type', "application/json");
          fetch('/api/reports', {
            method: "POST",
            headers: headers,
            body: JSON.stringify({draw_id: drawId}),
          }).then(response => response.json())
          .then(jsondata => {
            // console.log(jsondata);
            $.unblockUI();
            if (jsondata.report !== 0) {
              reportsTable.querySelector('#bets-number').innerHTML = jsondata.report.bets_sum;
              reportsTable.querySelector('#bets-amount').innerHTML = jsondata.report.bets_amount;
              reportsTable.querySelector('#winnings-number').innerHTML = jsondata.report.winnings_sum;
              reportsTable.querySelector('#winnings-amount').innerHTML = jsondata.report.winnings_amount;
              reportsTable.querySelector('#losings-number').innerHTML = jsondata.report.losings_sum;
              reportsTable.querySelector('#losings-amount').innerHTML = jsondata.report.losings_amount;
              document.getElementById('winnings-wrapper').innerHTML = `${jsondata.report.winnings} XOF`;
              document.getElementById('export-btn').dataset.export = `http://${window.location.host}/reports/${jsondata.export}`;
              const dtParams = {"model": "report-bets", "filter_data": {'draw_id': drawId, "placed_bet_status": "3"}, "date_search": "no", "from": '', "to": ''};
              window.fetchDatatable("#reports-datatable", dtParams);
            } else {
              window.Swal.fire({width: 400, icon: 'info', title: "Info!", html: 'Aucun rapport trouvé.', timer: 5000, type: "info", showCloseButton: true, allowOutsideClick: true});
            }
          })
        } else {
          window.Swal.fire({width: 400, icon: 'warning', title: "Attention!", html: 'Veuillez sélectionner un tirage', timer: 5000, type: "warning", showCloseButton: true, allowOutsideClick: true});
        }
      });

      $('#export-btn').click(function() {
        const exportUrl =  document.getElementById('export-btn').dataset.export;
        if (exportUrl !== "") {
          window.open(exportUrl, '_blank').focus();
        }
      });

      
    </script>
<% end %>